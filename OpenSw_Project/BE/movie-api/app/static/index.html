<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>MOVIEIN</title>
  <style>
    /* (기존 스타일 유지) */
  </style>
</head>
<body>
  <div id="header">
    <div id="logo" onclick="resetToLatest()">MOVIE</div>
    <div id="auth-buttons">
      <button onclick="location.href='login.html'">로그인</button>
      <button onclick="location.href='register.html'">회원가입</button>
    </div>
    <div id="user-menu" style="display:none;">
      <button onclick="location.href='mypage.html'">마이페이지</button>
      <button onclick="logout()">로그아웃</button>
    </div>
  </div>

  <div id="search-bar">
    <input id="query" placeholder="영화 제목을 입력하세요" />
    <button onclick="searchMovie()">검색</button>
  </div>

  <h2 id="section-title">최신 영화</h2>
  <div id="results" class="grid"></div>

  <script>
    const API_BASE = "http://localhost:8000";

    function isLoggedIn() {
      return !!localStorage.getItem('user_id');
    }

    function updateHeader() {
      if (isLoggedIn()) {
        document.getElementById('auth-buttons').style.display = 'none';
        document.getElementById('user-menu').style.display = 'flex';
      } else {
        document.getElementById('auth-buttons').style.display = 'flex';
        document.getElementById('user-menu').style.display = 'none';
      }
    }

    function logout() {
      localStorage.removeItem('user_id');
      updateHeader();
      resetToLatest();
    }

    async function fetchAndRender(path, titleText) {
      try {
        const res = await fetch(API_BASE + path);
        if (!res.ok) throw new Error(res.status + " " + res.statusText);
        const data = await res.json();

        document.getElementById("section-title").textContent = titleText;
        const container = document.getElementById("results");
        container.innerHTML = "";

        data.results.forEach(movie => {
          const d = document.createElement("div");
          d.className = "movie";
          d.onclick = () => location.href = `movie_detail.html?movie_id=${movie.id}`;

          const img = document.createElement("img");
          img.src = "https://image.tmdb.org/t/p/w200" + movie.poster_path;
          img.alt = movie.title;

          const h4 = document.createElement("h4");
          h4.textContent = movie.title;

          const p = document.createElement("p");
          p.textContent = (movie.overview || "").slice(0, 100) + "...";

          d.append(img, h4, p);
          container.appendChild(d);
        });
      } catch (e) {
        console.error("API 오류:", e);
        alert("API 오류: " + e.message);
      }
    }

    async function searchMovie() {
      const raw = document.getElementById("query").value;
      const query = raw.replace(/['"]/g, "").trim();
      if (!query) return alert("검색어를 입력하세요.");
      await fetchAndRender(`/search?query=${encodeURIComponent(query)}`, "검색 결과");
    }

    function resetToLatest() {
      document.getElementById("query").value = "";
      fetchAndRender("/latest", "최신 영화");
    }

    // 초기화
    updateHeader();
    resetToLatest();
  </script>
</body>
</html>
